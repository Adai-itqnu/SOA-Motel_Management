<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang ch·ªß - Ph√≤ng tr·ªç</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
      }

      .navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .navbar-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar-brand {
        font-size: 24px;
        font-weight: 600;
      }

      .navbar-user {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-info {
        text-align: right;
      }

      .user-name {
        font-weight: 600;
      }

      .user-role {
        font-size: 12px;
        opacity: 0.8;
      }

      .btn-logout {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-logout:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .container {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 20px;
      }

      .page-header {
        margin-bottom: 30px;
      }

      .page-header h1 {
        color: #333;
        font-size: 32px;
        margin-bottom: 10px;
      }

      .page-header p {
        color: #666;
      }

      .filters {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 30px;
      }

      .filter-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
      }

      .filter-item {
        flex: 1;
        min-width: 200px;
      }

      .filter-item label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
      }

      .filter-item input,
      .filter-item select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
      }

      .filter-item input:focus,
      .filter-item select:focus {
        outline: none;
        border-color: #667eea;
      }

      .rooms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
      }

      .room-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .room-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .room-image {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 60px;
      }

      .room-content {
        padding: 20px;
      }

      .room-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
      }

      .room-name {
        font-size: 20px;
        font-weight: 600;
        color: #333;
      }

      .room-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-available {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .room-info {
        margin-bottom: 15px;
      }

      .room-info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .room-info-item:last-child {
        border-bottom: none;
      }

      .room-info-label {
        color: #666;
      }

      .room-info-value {
        font-weight: 600;
        color: #333;
      }

      .room-price {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
        text-align: center;
        padding: 15px 0;
        border-top: 2px solid #f0f0f0;
      }

      .room-description {
        color: #666;
        font-size: 14px;
        margin-top: 10px;
        line-height: 1.6;
      }

      .no-rooms {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .no-rooms-icon {
        font-size: 80px;
        margin-bottom: 20px;
      }

      .no-rooms h3 {
        color: #333;
        font-size: 24px;
        margin-bottom: 10px;
      }

      .no-rooms p {
        color: #666;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .btn-book-room {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 15px;
        transition: all 0.3s;
      }

      .btn-book-room:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow: auto;
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }

      .modal-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
      }

      .close-modal {
        font-size: 28px;
        font-weight: bold;
        color: #999;
        cursor: pointer;
        transition: color 0.3s;
      }

      .close-modal:hover {
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
      }

      .btn-secondary {
        padding: 12px 24px;
        background: #f5f5f5;
        color: #333;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      .btn-primary {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .alert {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .alert-success {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }

      .alert-error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #f44336;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">üè† Qu·∫£n l√Ω Nh√† Tr·ªç</div>
        <div class="navbar-user">
          <div
            class="user-menu"
            style="display: flex; align-items: center; gap: 15px"
          >
            <div
              class="user-icon"
              style="
                width: 40px;
                height: 40px;
                background: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #667eea;
                font-weight: bold;
                font-size: 20px;
                cursor: pointer;
              "
              onclick="toggleUserMenu()"
            >
              <span id="userInitials">U</span>
            </div>
            <div
              class="notification-icon"
              style="position: relative; cursor: pointer; margin-right: 10px"
              onclick="toggleNotifications()"
            >
              <span style="font-size: 24px">üîî</span>
              <span
                id="notificationBadge"
                style="
                  position: absolute;
                  top: -5px;
                  right: -5px;
                  background: red;
                  color: white;
                  border-radius: 50%;
                  padding: 2px 6px;
                  font-size: 10px;
                  display: none;
                "
                >0</span
              >
              <div
                id="notificationDropdown"
                style="
                  display: none;
                  position: absolute;
                  top: 40px;
                  right: 0;
                  background: white;
                  border-radius: 8px;
                  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                  width: 300px;
                  max-height: 400px;
                  overflow-y: auto;
                  z-index: 101;
                "
              >
                <div
                  style="
                    padding: 10px;
                    border-bottom: 1px solid #eee;
                    font-weight: bold;
                  "
                >
                  Th√¥ng b√°o
                </div>
                <div id="notificationList" style="padding: 0">
                  <div style="padding: 15px; text-align: center; color: #666">
                    Kh√¥ng c√≥ th√¥ng b√°o m·ªõi
                  </div>
                </div>
              </div>
            </div>
            <div class="user-info">
              <div class="user-name" id="userName">User</div>
              <div class="user-role">Ng∆∞·ªùi d√πng</div>
            </div>
          </div>
          <div
            id="userDropdown"
            style="
              display: none;
              position: absolute;
              top: 60px;
              right: 20px;
              background: white;
              border-radius: 8px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
              padding: 10px;
              min-width: 200px;
              z-index: 100;
            "
          >
            <div
              style="
                padding: 8px 12px;
                cursor: pointer;
                color: #333;
                border-bottom: 1px solid #eee;
              "
              onclick="openProfileModal()"
            >
              üë§ Th√¥ng tin c√° nh√¢n
            </div>
            <div
              style="
                padding: 8px 12px;
                cursor: pointer;
                color: #333;
                border-bottom: 1px solid #eee;
              "
              onclick="openMyBookingsModal()"
            >
              üìÖ Y√™u c·∫ßu ƒë·∫∑t ph√≤ng
            </div>
            <div
              style="
                padding: 8px 12px;
                cursor: pointer;
                color: #333;
                border-bottom: 1px solid #eee;
              "
              onclick="openMyBillsModal()"
            >
              üßæ H√≥a ƒë∆°n c·ªßa t√¥i
            </div>
            <div
              style="
                padding: 8px 12px;
                cursor: pointer;
                color: #333;
                border-bottom: 1px solid #eee;
              "
              onclick="openPayDepositModal()"
            >
              üí≥ Thanh to√°n h√≥a ƒë∆°n
            </div>
            <div
              style="
                padding: 8px 12px;
                cursor: pointer;
                color: #333;
                border-bottom: 1px solid #eee;
              "
              onclick="openPaymentHistoryModal()"
            >
              üìã L·ªãch s·ª≠ thanh to√°n
            </div>
            <div
              style="padding: 8px 12px; cursor: pointer; color: #c33"
              onclick="logout()"
            >
              üö™ ƒêƒÉng xu·∫•t
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="page-header">
        <h1>Danh s√°ch ph√≤ng tr·ªëng</h1>
        <p>T√¨m ph√≤ng tr·ªç ph√π h·ª£p v·ªõi nhu c·∫ßu c·ªßa b·∫°n</p>
      </div>

      <div class="filters">
        <div class="filter-group">
          <div class="filter-item">
            <label for="searchInput">T√¨m ki·∫øm</label>
            <input
              type="text"
              id="searchInput"
              placeholder="Nh·∫≠p t√™n ph√≤ng..."
            />
          </div>
          <div class="filter-item">
            <label for="sortBy">S·∫Øp x·∫øp theo</label>
            <select id="sortBy">
              <option value="name">T√™n ph√≤ng</option>
              <option value="price-asc">Gi√° th·∫•p ƒë·∫øn cao</option>
              <option value="price-desc">Gi√° cao ƒë·∫øn th·∫•p</option>
            </select>
          </div>
        </div>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i danh s√°ch ph√≤ng...</p>
      </div>

      <div id="roomsGrid" class="rooms-grid"></div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">ƒê·∫∑t ph√≤ng</h2>
          <span class="close-modal" onclick="closeBookingModal()">&times;</span>
        </div>
        <div id="bookingAlert" class="alert"></div>
        <form id="bookingForm">
          <input type="hidden" id="bookingRoomId" />
          <div class="form-group">
            <label>Ph√≤ng</label>
            <input type="text" id="bookingRoomName" readonly />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ng√†y b·∫Øt ƒë·∫ßu *</label>
              <input type="date" id="bookingStartDate" required />
            </div>
            <div class="form-group">
              <label>Ng√†y k·∫øt th√∫c * (T·ªëi thi·ªÉu 1 th√°ng)</label>
              <input type="date" id="bookingEndDate" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Gi√° thu√™/th√°ng (VNƒê)</label>
              <input type="number" id="bookingMonthlyRent" readonly />
            </div>
            <div class="form-group">
              <label>Ti·ªÅn c·ªçc (VNƒê)</label>
              <input type="number" id="bookingDeposit" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n ti·ªÅn c·ªçc *</label>
            <div style="display: flex; flex-direction: column; gap: 6px">
              <label style="display: flex; align-items: center; gap: 8px">
                <input
                  type="radio"
                  name="bookingDepositMethod"
                  value="vnpay"
                  checked
                />
                <span>Thanh to√°n qua VNPay</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px">
                <input type="radio" name="bookingDepositMethod" value="cash" />
                <span>Thanh to√°n ti·ªÅn m·∫∑t khi g·∫∑p tr·ª±c ti·∫øp</span>
              </label>
            </div>
            <small style="color: #777"
              >Ch·ªâ khi thanh to√°n VNPay/MoMo th√†nh c√¥ng ph√≤ng m·ªõi ƒë∆∞·ª£c gi·ªØ cho
              b·∫°n.</small
            >
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Gi√° ƒëi·ªán (VNƒê/kWh)</label>
              <input type="number" id="bookingElectricPrice" readonly />
            </div>
            <div class="form-group">
              <label>Gi√° n∆∞·ªõc (VNƒê/m¬≥)</label>
              <input type="number" id="bookingWaterPrice" readonly />
            </div>
          </div>
          <div class="form-group">
            <label>Ng√†y thanh to√°n h√†ng th√°ng</label>
            <input
              type="number"
              id="bookingPaymentDay"
              min="1"
              max="31"
              readonly
            />
          </div>
          <div class="form-group">
            <label>Ghi ch√∫</label>
            <textarea id="bookingNotes" rows="3" readonly></textarea>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeBookingModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="btn-primary">
              G·ª≠i y√™u c·∫ßu ƒë·∫∑t ph√≤ng
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Th√¥ng tin c√° nh√¢n</h2>
          <span class="close-modal" onclick="closeProfileModal()">&times;</span>
        </div>
        <div id="profileAlert" class="alert"></div>
        <form id="profileForm">
          <div class="form-group">
            <label>H·ªç t√™n</label>
            <input type="text" id="profileName" required />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="profileEmail" required />
          </div>
          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="tel" id="profilePhone" placeholder="C·∫≠p nh·∫≠t SƒêT" />
          </div>
          <div class="form-group">
            <label>CMND/CCCD</label>
            <input
              type="text"
              id="profileIdCard"
              placeholder="C·∫≠p nh·∫≠t CMND/CCCD"
            />
          </div>
          <div class="form-group">
            <label>ƒê·ªãa ch·ªâ</label>
            <input
              type="text"
              id="profileAddress"
              placeholder="C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ"
            />
          </div>
          <div class="form-group">
            <label>Ng√†y sinh</label>
            <input type="date" id="profileDob" />
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeProfileModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="btn-primary">L∆∞u thay ƒë·ªïi</button>
          </div>
        </form>
      </div>
    </div>

    <!-- My Bookings Modal -->
    <div id="myBookingsModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h2 class="modal-title">Y√™u c·∫ßu ƒë·∫∑t ph√≤ng c·ªßa t√¥i</h2>
          <span class="close-modal" onclick="closeMyBookingsModal()"
            >&times;</span
          >
        </div>
        <div id="myBookingsList">
          <!-- Bookings will be loaded here -->
          <div class="loading">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- My Bills Modal -->
    <div id="myBillsModal" class="modal">
      <div class="modal-content" style="max-width: 900px">
        <div class="modal-header">
          <h2 class="modal-title">H√≥a ƒë∆°n c·ªßa t√¥i</h2>
          <span class="close-modal" onclick="closeMyBillsModal()">&times;</span>
        </div>
        <div id="myBillsList">
          <!-- Bills will be loaded here -->
          <div class="loading">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pay Deposit Modal -->
    <div id="payDepositModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Thanh to√°n ti·ªÅn ph√≤ng</h2>
          <span class="close-modal" onclick="closePayDepositModal()"
            >&times;</span
          >
        </div>
        <div id="payDepositAlert" class="alert"></div>
        <form id="payDepositForm">
          <div class="form-group">
            <label>Lo·∫°i thanh to√°n *</label>
            <select id="depositPaymentType" required>
              <option value="">Ch·ªçn lo·∫°i</option>
              <option value="booking">Ti·ªÅn c·ªçc ƒë·∫∑t ph√≤ng</option>
              <option value="contract">Ti·ªÅn c·ªçc h·ª£p ƒë·ªìng</option>
            </select>
          </div>
          <div class="form-group" id="bookingIdGroup" style="display: none">
            <label>Ch·ªçn booking *</label>
            <select id="depositBookingId"></select>
          </div>
          <div class="form-group" id="contractIdGroup" style="display: none">
            <label>Ch·ªçn h·ª£p ƒë·ªìng *</label>
            <select id="depositContractId"></select>
          </div>
          <div class="form-group">
            <label>S·ªë ti·ªÅn (VNƒê) *</label>
            <input type="number" id="depositAmount" required />
          </div>
          <div class="form-group">
            <label>Ph∆∞∆°ng th·ª©c thanh to√°n *</label>
            <div style="display: flex; gap: 15px">
              <div style="margin-bottom: 8px">
                <input
                  type="radio"
                  name="depositMethod"
                  value="vnpay"
                  checked
                />
                VNPay
                <input type="radio" name="depositMethod" value="cash" /> Ti·ªÅn
                m·∫∑t
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              onclick="closePayDepositModal()"
            >
              H·ªßy
            </button>
            <button type="submit" class="btn-primary" id="payDepositBtn">
              Thanh to√°n
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Payment History Modal -->
    <div id="paymentHistoryModal" class="modal">
      <div class="modal-content" style="max-width: 900px">
        <div class="modal-header">
          <h2 class="modal-title">L·ªãch s·ª≠ thanh to√°n</h2>
          <span class="close-modal" onclick="closePaymentHistoryModal()"
            >&times;</span
          >
        </div>
        <div id="paymentHistoryList">
          <!-- Payments will be loaded here -->
          <div class="loading">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i...</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_GATEWAY = "{{ api_gateway }}";
      window.API_GATEWAY = API_GATEWAY; // Make it available globally
      let allRooms = [];

      // Check authentication
      async function checkAuth() {
        const token = localStorage.getItem("token");

        if (!token) {
          window.location.href = "/login";
          return;
        }

        try {
          // Fetch fresh user data
          const response = await fetch(`${API_GATEWAY}/api/auth/me`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const userData = await response.json();
            localStorage.setItem("user", JSON.stringify(userData));
            updateUserUI(userData);
          } else {
            // Fallback to local storage if fetch fails
            const user = JSON.parse(localStorage.getItem("user") || "{}");
            updateUserUI(user);
          }
        } catch (e) {
          const user = JSON.parse(localStorage.getItem("user") || "{}");
          updateUserUI(user);
        }
      }

      function updateUserUI(user) {
        const name = user.name || user.username || "User";
        document.getElementById("userName").textContent = name;

        // Set initials
        const initials = name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .substring(0, 2)
          .toUpperCase();
        document.getElementById("userInitials").textContent = initials;
      }

      // Logout
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/login";
      }

      // User Menu
      function toggleUserMenu() {
        const dropdown = document.getElementById("userDropdown");
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";
      }

      // Close dropdown when clicking outside
      window.onclick = function (event) {
        if (!event.target.closest(".navbar-user")) {
          document.getElementById("userDropdown").style.display = "none";
        }
        if (event.target == document.getElementById("profileModal")) {
          closeProfileModal();
        }
        if (event.target == document.getElementById("bookingModal")) {
          closeBookingModal();
        }
        if (!event.target.closest(".notification-icon")) {
          document.getElementById("notificationDropdown").style.display =
            "none";
        }
      };

      // Notification Logic
      function toggleNotifications() {
        const dropdown = document.getElementById("notificationDropdown");
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";
        if (dropdown.style.display === "block") {
          loadNotifications();
        }
      }

      async function loadNotifications() {
        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          const response = await fetch(`${API_GATEWAY}/api/notifications`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const data = await response.json();
            renderNotifications(data.notifications || []);
            updateNotificationBadge(data.notifications || []);
          }
        } catch (error) {
          console.error("Error loading notifications:", error);
        }
      }

      function renderNotifications(notifications) {
        const list = document.getElementById("notificationList");
        if (notifications.length === 0) {
          list.innerHTML =
            '<div style="padding: 15px; text-align: center; color: #666;">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>';
          return;
        }

        list.innerHTML = notifications
          .map(
            (notif) => `
            <div style="padding: 10px; border-bottom: 1px solid #eee; ${
              notif.read ? "" : "background: #f0f7ff;"
            }">
                <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px;">${
                  notif.title
                }</div>
                <div style="font-size: 13px; color: #555;">${
                  notif.message
                }</div>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">${new Date(
                  notif.created_at
                ).toLocaleString("vi-VN")}</div>
            </div>
        `
          )
          .join("");
      }

      function updateNotificationBadge(notifications) {
        const unreadCount = notifications.filter((n) => !n.read).length;
        const badge = document.getElementById("notificationBadge");
        if (unreadCount > 0) {
          badge.textContent = unreadCount;
          badge.style.display = "block";
        } else {
          badge.style.display = "none";
        }
      }

      // Auto load notifications
      setInterval(loadNotifications, 60000); // Check every minute
      loadNotifications(); // Initial load

      // Profile Functions
      function openProfileModal() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        document.getElementById("profileName").value = user.name || "";
        document.getElementById("profileEmail").value = user.email || "";
        document.getElementById("profilePhone").value = user.phone || "";
        document.getElementById("profileIdCard").value = user.id_card || "";
        document.getElementById("profileAddress").value = user.address || "";
        document.getElementById("profileDob").value = user.date_of_birth || "";

        document.getElementById("profileModal").style.display = "block";
        document.getElementById("userDropdown").style.display = "none";
      }

      function closeProfileModal() {
        document.getElementById("profileModal").style.display = "none";
      }

      document
        .getElementById("profileForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const token = localStorage.getItem("token");
          const alertDiv = document.getElementById("profileAlert");

          const formData = {
            name: document.getElementById("profileName").value,
            email: document.getElementById("profileEmail").value,
            phone: document.getElementById("profilePhone").value,
            id_card: document.getElementById("profileIdCard").value,
            address: document.getElementById("profileAddress").value,
            date_of_birth: document.getElementById("profileDob").value,
          };

          try {
            const response = await fetch(`${API_GATEWAY}/api/auth/profile`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (response.ok) {
              localStorage.setItem("user", JSON.stringify(data.user));
              updateUserUI(data.user);

              alertDiv.className = "alert alert-success";
              alertDiv.textContent = "C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!";
              alertDiv.style.display = "block";

              setTimeout(() => {
                closeProfileModal();
                alertDiv.style.display = "none";
              }, 1500);
            } else {
              throw new Error(data.message || "C·∫≠p nh·∫≠t th·∫•t b·∫°i");
            }
          } catch (error) {
            alertDiv.className = "alert alert-error";
            alertDiv.textContent = error.message;
            alertDiv.style.display = "block";
          }
        });

      // My Bookings Functions
      async function openMyBookingsModal() {
        document.getElementById("myBookingsModal").style.display = "block";
        document.getElementById("userDropdown").style.display = "none";
        await loadMyBookings();
      }

      function closeMyBookingsModal() {
        document.getElementById("myBookingsModal").style.display = "none";
      }

      async function loadMyBookings() {
        const listDiv = document.getElementById("myBookingsList");
        const token = localStorage.getItem("token");

        try {
          const response = await fetch(`${API_GATEWAY}/api/bookings`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            renderMyBookings(data.bookings);
          } else {
            throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch booking");
          }
        } catch (error) {
          listDiv.innerHTML = `<div style="text-align: center; color: #c33; padding: 20px;">${error.message}</div>`;
        }
      }

      function renderMyBookings(bookings) {
        const listDiv = document.getElementById("myBookingsList");

        if (bookings.length === 0) {
          listDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 40px; margin-bottom: 10px;">üìÖ</div>
                    <p>B·∫°n ch∆∞a c√≥ y√™u c·∫ßu ƒë·∫∑t ph√≤ng n√†o</p>
                </div>
            `;
          return;
        }

        listDiv.innerHTML = bookings
          .map(
            (booking) => `
            <div style="background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div style="font-weight: bold; color: #333;">${
                      booking.room_info.name
                    }</div>
                    <div style="
                        padding: 4px 10px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        font-weight: bold;
                        ${getStatusStyle(booking.status)}
                    ">
                        ${getStatusText(booking.status)}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; color: #555;">
                    <div>üìÖ Ng√†y b·∫Øt ƒë·∫ßu: ${new Date(
                      booking.start_date
                    ).toLocaleDateString("vi-VN")}</div>
                    <div>üìÖ Ng√†y k·∫øt th√∫c: ${new Date(
                      booking.end_date
                    ).toLocaleDateString("vi-VN")}</div>
                    <div>üí∞ Gi√° thu√™: ${formatPrice(booking.monthly_rent)}</div>
                    <div>üíµ Ti·ªÅn c·ªçc: ${formatPrice(booking.deposit)}</div>
                </div>
                ${
                  booking.status === "pending"
                    ? `
                    <div style="margin-top: 10px; text-align: right;">
                        <button onclick="cancelBooking('${booking.id}')" style="padding: 5px 10px; background: #fee; color: #c33; border: 1px solid #fcc; border-radius: 4px; cursor: pointer;">H·ªßy y√™u c·∫ßu</button>
                    </div>
                `
                    : ""
                }
                ${
                  booking.status === "rejected"
                    ? `
                    <div style="margin-top: 10px; padding: 10px; background: #fee; color: #c33; border-radius: 4px; font-size: 13px;">
                        L√Ω do t·ª´ ch·ªëi: ${
                          booking.rejection_reason || "Kh√¥ng c√≥ l√Ω do"
                        }
                    </div>
                `
                    : ""
                }
            </div>
        `
          )
          .join("");
      }

      function getStatusStyle(status) {
        switch (status) {
          case "pending":
            return "background: #fff3e0; color: #e65100;";
          case "approved":
            return "background: #e8f5e9; color: #2e7d32;";
          case "rejected":
            return "background: #ffebee; color: #c62828;";
          case "cancelled":
            return "background: #f5f5f5; color: #757575;";
          default:
            return "background: #f5f5f5; color: #333;";
        }
      }

      function getStatusText(status) {
        switch (status) {
          case "pending":
            return "Ch·ªù duy·ªát";
          case "approved":
            return "ƒê√£ duy·ªát";
          case "rejected":
            return "B·ªã t·ª´ ch·ªëi";
          case "cancelled":
            return "ƒê√£ h·ªßy";
          default:
            return status;
        }
      }

      async function cancelBooking(bookingId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy y√™u c·∫ßu n√†y?")) return;

        const token = localStorage.getItem("token");
        try {
          const response = await fetch(
            `${API_GATEWAY}/api/bookings/${bookingId}/cancel`,
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (response.ok) {
            loadMyBookings();
          } else {
            alert("Kh√¥ng th·ªÉ h·ªßy booking");
          }
        } catch (e) {
          alert("L·ªói k·∫øt n·ªëi");
        }
      }

      // Format price
      function formatPrice(price) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(price);
      }

      // Render rooms
      function renderRooms(rooms) {
        const grid = document.getElementById("roomsGrid");

        if (rooms.length === 0) {
          grid.innerHTML = `
                    <div class="no-rooms">
                        <span class="menu-item-icon">üí≥</span>
                <span class="menu-item-text">Thanh to√°n ti·ªÅn ph√≤ng</span>
              </a>          <p>Hi·ªán t·∫°i kh√¥ng c√≥ ph√≤ng n√†o ph√π h·ª£p v·ªõi ti√™u ch√≠ c·ªßa b·∫°n</p>
                    </div>
                `;
          return;
        }

        grid.innerHTML = rooms
          .map((room) => {
            const roomId = room.id || room._id;
            const roomName = (room.name || "").replace(/'/g, "\\'");
            const roomPrice = room.price || 0;
            const roomDeposit = room.deposit || 0;
            const roomElectricPrice = room.electric_price || 3500;
            const roomWaterPrice = room.water_price || 20000;
            const roomPaymentDay = room.payment_day || 5;

            return `
                <div class="room-card">
                    <div class="room-image">üè†</div>
                    <div class="room-content">
                        <div class="room-header">
                            <div class="room-name">${room.name}</div>
                            <span class="room-status status-available">C√≤n tr·ªëng</span>
                        </div>
                        
                        <div class="room-info">
                            <div class="room-info-item">
                                <span class="room-info-label">Lo·∫°i ph√≤ng:</span>
                                <span class="room-info-value">${
                                  room.room_type
                                }</span>
                            </div>
                        </div>
                        
                        ${
                          room.description
                            ? `
                            <div class="room-description">${room.description}</div>
                        `
                            : ""
                        }
                        
                        <div class="room-price">
                            ${formatPrice(room.price)}/th√°ng
                        </div>
                        <button class="btn-book-room" onclick="openBookingModal({
                            id: '${roomId}',
                            name: '${roomName}',
                            price: ${roomPrice},
                            deposit: ${roomDeposit},
                            electric_price: ${roomElectricPrice},
                            water_price: ${roomWaterPrice},
                            payment_day: ${roomPaymentDay}
                        })">
                            ƒê·∫∑t ph√≤ng
                        </button>
                    </div>
                </div>
            `;
          })
          .join("");
      }

      // Load rooms
      async function loadRooms() {
        const loading = document.getElementById("loading");
        const grid = document.getElementById("roomsGrid");

        loading.style.display = "block";
        grid.style.display = "none";

        try {
          const response = await fetch("/api/rooms/available");

          if (!response.ok) {
            throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph√≤ng");
          }

          const data = await response.json();
          allRooms = data.rooms;

          loading.style.display = "none";
          grid.style.display = "grid";

          filterAndSortRooms();
        } catch (error) {
          loading.innerHTML = `
                    <div style="color: #c33;">
                        <p>‚ùå ${error.message}</p>
                    </div>
                `;
        }
      }

      // Filter and sort
      function filterAndSortRooms() {
        const searchText = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const sortBy = document.getElementById("sortBy").value;

        let filtered = allRooms.filter((room) =>
          room.name.toLowerCase().includes(searchText)
        );

        // Sort
        if (sortBy === "price-asc") {
          filtered.sort((a, b) => a.price - b.price);
        } else if (sortBy === "price-desc") {
          filtered.sort((a, b) => b.price - a.price);
        } else {
          filtered.sort((a, b) => a.name.localeCompare(b.name));
        }

        renderRooms(filtered);
      }

      // Event listeners
      document
        .getElementById("searchInput")
        .addEventListener("input", filterAndSortRooms);
      document
        .getElementById("sortBy")
        .addEventListener("change", filterAndSortRooms);

      // Booking Modal Functions
      function openBookingModal(roomData) {
        // Check if user has ID Card (CCCD)
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        if (!user.id_card || user.id_card.trim() === "") {
          if (
            confirm(
              "B·∫°n c·∫ßn c·∫≠p nh·∫≠t CMND/CCCD tr∆∞·ªõc khi ƒë·∫∑t ph√≤ng. B·∫°n c√≥ mu·ªën c·∫≠p nh·∫≠t ngay kh√¥ng?"
            )
          ) {
            openProfileModal();
          }
          return;
        }

        // roomData c√≥ th·ªÉ l√† object ho·∫∑c string (t·ª´ onclick)
        if (typeof roomData === "string") {
          try {
            roomData = JSON.parse(roomData.replace(/&quot;/g, '"'));
          } catch (e) {
            console.error("Error parsing room data:", e);
            return;
          }
        }

        const modal = document.getElementById("bookingModal");
        const roomIdInput = document.getElementById("bookingRoomId");
        const roomNameInput = document.getElementById("bookingRoomName");
        const monthlyRentInput = document.getElementById("bookingMonthlyRent");
        const depositInput = document.getElementById("bookingDeposit");
        const electricPriceInput = document.getElementById(
          "bookingElectricPrice"
        );
        const waterPriceInput = document.getElementById("bookingWaterPrice");
        const paymentDayInput = document.getElementById("bookingPaymentDay");
        const notesInput = document.getElementById("bookingNotes");
        const alert = document.getElementById("bookingAlert");

        // Fill form with room data (all read-only except dates)
        if (roomIdInput) roomIdInput.value = roomData.id;
        if (roomNameInput) roomNameInput.value = roomData.name;
        if (monthlyRentInput) {
          monthlyRentInput.value = roomData.price || 0;
          monthlyRentInput.readOnly = true;
        }
        if (depositInput) {
          depositInput.value = roomData.deposit || 0;
          depositInput.readOnly = true;
        }
        if (electricPriceInput) {
          electricPriceInput.value = roomData.electric_price || 3500;
          electricPriceInput.readOnly = true;
        }
        if (waterPriceInput) {
          waterPriceInput.value = roomData.water_price || 20000;
          waterPriceInput.readOnly = true;
        }
        if (paymentDayInput) {
          paymentDayInput.value = roomData.payment_day || 5;
          paymentDayInput.readOnly = true;
        }
        if (notesInput) {
          notesInput.value = "";
          notesInput.readOnly = true;
        }

        if (alert) alert.style.display = "none";

        // Set minimum date to today - only these fields are editable
        const today = new Date().toISOString().split("T")[0];
        const startDateInput = document.getElementById("bookingStartDate");
        const endDateInput = document.getElementById("bookingEndDate");
        if (startDateInput) {
          startDateInput.min = today;
          startDateInput.value = today;
          startDateInput.readOnly = false;
        }
        if (endDateInput) {
          endDateInput.min = today;
          endDateInput.readOnly = false;
        }

        if (modal) modal.style.display = "block";
      }

      function closeBookingModal() {
        const modal = document.getElementById("bookingModal");
        if (modal) modal.style.display = "none";
        const form = document.getElementById("bookingForm");
        if (form) form.reset();
        // Reset readonly status
        const readonlyFields = [
          "bookingMonthlyRent",
          "bookingDeposit",
          "bookingElectricPrice",
          "bookingWaterPrice",
          "bookingPaymentDay",
          "bookingNotes",
        ];
        readonlyFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (field) field.readOnly = true;
        });
      }

      // Handle booking form submission
      document
        .getElementById("bookingForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const bookingAlert = document.getElementById("bookingAlert");
          const token = localStorage.getItem("token");
          if (!token) {
            window.location.href = "/login";
            return;
          }

          const roomId = document.getElementById("bookingRoomId").value;
          const startDate = document.getElementById("bookingStartDate").value;
          const endDate = document.getElementById("bookingEndDate").value;

          // Validate minimum 1 month duration
          if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const minEnd = new Date(start);
            minEnd.setMonth(minEnd.getMonth() + 1); // Add 1 month

            if (end < minEnd) {
              if (bookingAlert) {
                bookingAlert.className = "alert alert-error";
                bookingAlert.textContent =
                  "Th·ªùi gian thu√™ t·ªëi thi·ªÉu l√† 1 th√°ng! Vui l√≤ng ch·ªçn ng√†y k·∫øt th√∫c √≠t nh·∫•t 1 th√°ng sau ng√†y b·∫Øt ƒë·∫ßu.";
                bookingAlert.style.display = "block";
              }
              return;
            }
          }

          const monthlyRentInput =
            document.getElementById("bookingMonthlyRent");
          const depositInput = document.getElementById("bookingDeposit");
          const electricPriceInput = document.getElementById(
            "bookingElectricPrice"
          );
          const waterPriceInput = document.getElementById("bookingWaterPrice");
          const paymentDayInput = document.getElementById("bookingPaymentDay");
          const notesInput = document.getElementById("bookingNotes");
          const depositMethodInput = document.querySelector(
            'input[name="bookingDepositMethod"]:checked'
          );

          // Parse c√°c gi√° tr·ªã s·ªë, ƒë·∫£m b·∫£o kh√¥ng l·ªói
          const monthlyRent = parseFloat(monthlyRentInput?.value || 0);
          const deposit = parseFloat(depositInput?.value || 0);
          const electricPrice = parseFloat(electricPriceInput?.value || 3500);
          const waterPrice = parseFloat(waterPriceInput?.value || 20000);
          const paymentDay = parseInt(paymentDayInput?.value || 5);
          const notes = notesInput?.value || "";
          const depositMethod = depositMethodInput?.value || "vnpay";

          // Validation
          if (!roomId) {
            if (bookingAlert) {
              bookingAlert.className = "alert alert-error";
              bookingAlert.textContent = "Kh√¥ng t√¨m th·∫•y th√¥ng tin ph√≤ng!";
              bookingAlert.style.display = "block";
            }
            return;
          }

          if (!startDate || !endDate) {
            if (bookingAlert) {
              bookingAlert.className = "alert alert-error";
              bookingAlert.textContent =
                "Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c!";
              bookingAlert.style.display = "block";
            }
            return;
          }

          if (new Date(endDate) <= new Date(startDate)) {
            if (bookingAlert) {
              bookingAlert.className = "alert alert-error";
              bookingAlert.textContent = "Ng√†y k·∫øt th√∫c ph·∫£i sau ng√†y b·∫Øt ƒë·∫ßu!";
              bookingAlert.style.display = "block";
            }
            return;
          }

          // Validate s·ªë
          if (isNaN(monthlyRent) || monthlyRent <= 0) {
            if (bookingAlert) {
              bookingAlert.className = "alert alert-error";
              bookingAlert.textContent = "Gi√° thu√™ kh√¥ng h·ª£p l·ªá!";
              bookingAlert.style.display = "block";
            }
            return;
          }

          if (isNaN(deposit) || deposit < 0) {
            if (bookingAlert) {
              bookingAlert.className = "alert alert-error";
              bookingAlert.textContent = "Ti·ªÅn c·ªçc kh√¥ng h·ª£p l·ªá!";
              bookingAlert.style.display = "block";
            }
            return;
          }

          console.log("Booking data:", {
            room_id: roomId,
            start_date: startDate,
            end_date: endDate,
            monthly_rent: monthlyRent,
            deposit: deposit,
            electric_price: electricPrice,
            water_price: waterPrice,
            payment_day: paymentDay,
            notes: notes,
          });

          try {
            const response = await fetch("/api/bookings", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                room_id: roomId,
                start_date: startDate,
                end_date: endDate,
                monthly_rent: parseFloat(monthlyRent),
                deposit: parseFloat(deposit),
                electric_price: parseFloat(electricPrice),
                water_price: parseFloat(waterPrice),
                payment_day: parseInt(paymentDay),
                notes: notes,
                deposit_method: depositMethod,
              }),
            });

            const data = await response.json();
            console.log("Booking response:", data);

            if (!response.ok) {
              const errorMsg =
                data.message || data.error || "C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t ph√≤ng";
              console.error("Booking error:", errorMsg);
              throw new Error(errorMsg);
            }

            const bookingId = data.booking?.id || data.booking?._id;
            const depositAmount =
              parseFloat(data.booking?.deposit ?? deposit ?? 0) || 0;
            const shouldAutoPayDeposit =
              bookingId &&
              depositAmount > 0 &&
              depositMethod === "vnpay" &&
              typeof window.payDepositForBooking === "function";

            if (shouldAutoPayDeposit) {
              if (bookingAlert) {
                bookingAlert.className = "alert alert-success";
                bookingAlert.textContent =
                  (data.message ||
                    "ƒê·∫∑t ph√≤ng th√†nh c√¥ng! Vui l√≤ng ch·ªù admin duy·ªát.") +
                  " ƒêang chuy·ªÉn t·ªõi VNPay ƒë·ªÉ thanh to√°n ti·ªÅn c·ªçc...";
                bookingAlert.style.display = "block";
              }

              try {
                await window.payDepositForBooking({
                  bookingId,
                  amount: depositAmount,
                  method: depositMethod,
                });
                return;
              } catch (paymentError) {
                console.error("Deposit payment error:", paymentError);
                if (bookingAlert) {
                  bookingAlert.className = "alert alert-error";
                  bookingAlert.textContent =
                    paymentError.message ||
                    "Kh√¥ng th·ªÉ kh·ªüi t·∫°o thanh to√°n ti·ªÅn c·ªçc. B·∫°n c√≥ th·ªÉ th·ª≠ l·∫°i trong m·ª•c Thanh to√°n.";
                  bookingAlert.style.display = "block";
                }
              }
            }

            if (bookingAlert) {
              bookingAlert.className = "alert alert-success";
              bookingAlert.textContent =
                data.message ||
                "ƒê·∫∑t ph√≤ng th√†nh c√¥ng! Vui l√≤ng ch·ªù admin duy·ªát.";
              bookingAlert.style.display = "block";
            }

            // Close modal after 2 seconds
            setTimeout(() => {
              closeBookingModal();
            }, 2000);
          } catch (error) {
            console.error("Booking submission error:", error);
            if (bookingAlert) {
              bookingAlert.className = "alert alert-error";
              bookingAlert.textContent =
                error.message ||
                "C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t ph√≤ng. Vui l√≤ng th·ª≠ l·∫°i!";
              bookingAlert.style.display = "block";
            }
          }
        });

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("bookingModal");
        if (event.target === modal) {
          closeBookingModal();
        }
      };

      // Initialize
      checkAuth();
      loadRooms();
    </script>
    <script src="/static/js/user-bills.js"></script>
    <script src="/static/js/user-payments.js"></script>
  </body>
</html>
