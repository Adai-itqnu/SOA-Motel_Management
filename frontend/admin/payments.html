<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ thanh to√°n - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#6366f1', secondary: '#8b5cf6' } } }
        }
    </script>
    <style>
        .tab-btn.active { background: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="sidebarContainer"></div>

    <main class="lg:ml-64 p-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">L·ªãch s·ª≠ thanh to√°n</h1>
                <p class="text-gray-500">Xem t·∫•t c·∫£ giao d·ªãch thanh to√°n</p>
            </div>
            <button onclick="loadData()" class="mt-4 md:mt-0 px-4 py-2 bg-white text-gray-700 rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
                üîÑ L√†m m·ªõi
            </button>
        </div>

        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-6">
            <button onclick="switchTab('deposits')" id="tabDeposits" class="tab-btn active px-5 py-3 rounded-xl font-medium transition">
                üí∞ Thanh to√°n c·ªçc
            </button>
            <button onclick="switchTab('monthly')" id="tabMonthly" class="tab-btn bg-white px-5 py-3 rounded-xl font-medium transition hover:bg-gray-50">
                üìã Thanh to√°n ti·ªÅn ph√≤ng h√†ng th√°ng
            </button>
        </div>

        <!-- Tab 1: Deposit Payments -->
        <div id="contentDeposits" class="tab-content">
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">T·ªïng giao d·ªãch</p>
                    <p class="text-2xl font-bold text-gray-800" id="depositCount">0</p>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">ƒêang ch·ªù</p>
                    <p class="text-2xl font-bold text-amber-600" id="depositPending">0</p>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">Th√†nh c√¥ng</p>
                    <p class="text-2xl font-bold text-green-600" id="depositSuccess">0</p>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">T·ªïng ti·ªÅn c·ªçc thu</p>
                    <p class="text-xl font-bold text-indigo-600" id="depositTotal">0 ƒë</p>
                </div>
            </div>

            <!-- Deposits Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√£ GD</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ph√≤ng</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng∆∞·ªùi thu√™</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">S·ªë ti·ªÅn</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ph∆∞∆°ng th·ª©c</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√£ VNPay</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng√†y t·∫°o</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="depositsTable" class="divide-y divide-gray-100">
                            <tr><td colspan="8" class="px-4 py-8 text-center text-gray-400">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 2: Monthly Rent Payments -->
        <div id="contentMonthly" class="tab-content hidden">
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">T·ªïng giao d·ªãch</p>
                    <p class="text-2xl font-bold text-gray-800" id="monthlyCount">0</p>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">ƒêang ch·ªù</p>
                    <p class="text-2xl font-bold text-amber-600" id="monthlyPending">0</p>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">Th√†nh c√¥ng</p>
                    <p class="text-2xl font-bold text-green-600" id="monthlySuccess">0</p>
                </div>
                <div class="bg-white rounded-xl shadow p-4">
                    <p class="text-sm text-gray-500">T·ªïng thu th√°ng</p>
                    <p class="text-xl font-bold text-indigo-600" id="monthlyTotal">0 ƒë</p>
                </div>
            </div>

            <!-- Monthly Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">M√£ GD</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">H√≥a ƒë∆°n</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ph√≤ng</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng∆∞·ªùi thu√™</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">S·ªë ti·ªÅn</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ph∆∞∆°ng th·ª©c</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ng√†y TT</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTable" class="divide-y divide-gray-100">
                            <tr><td colspan="8" class="px-4 py-8 text-center text-gray-400">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="/assets/js/common.js"></script>
    <script src="/assets/js/admin/layout.js"></script>
    <script>
        let deposits = [], monthlyPayments = [];
        let roomsMap = {}, usersMap = {};

        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof AdminLayout !== 'undefined') AdminLayout.init();
            else if (!Auth.checkAuth('admin')) return;
            
            await loadRooms();
            await loadUsers();
            await loadData();
        });

        async function loadRooms() {
            try {
                const res = await API.get('/rooms');
                if (res.ok) (res.data.rooms || []).forEach(r => roomsMap[r._id] = r.name);
            } catch(e) {}
        }

        async function loadUsers() {
            try {
                const res = await API.get('/users');
                if (res.ok) (res.data.users || []).forEach(u => usersMap[u._id] = u.fullname || u.name || u.email);
            } catch(e) {}
        }

        async function loadData() {
            try {
                const res = await API.get('/payments');
                if (res.ok) {
                    const all = res.data.payments || [];
                    // Split by type
                    deposits = all.filter(p => p.payment_type === 'room_reservation_deposit' || p.payment_type === 'booking_deposit');
                    monthlyPayments = all.filter(p => p.payment_type === 'bill_payment' || p.payment_type === 'monthly_rent');
                    
                    updateDepositStats();
                    updateMonthlyStats();
                    renderDeposits();
                    renderMonthly();
                }
            } catch(e) { console.error(e); }
        }

        function switchTab(tab) {
            ['Deposits', 'Monthly'].forEach(t => {
                const btn = document.getElementById('tab' + t);
                const content = document.getElementById('content' + t);
                if (t.toLowerCase() === tab) {
                    btn.classList.add('active');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('active');
                    content.classList.add('hidden');
                }
            });
        }

        // ============ Deposits ============
        function updateDepositStats() {
            const pending = deposits.filter(d => d.status === 'pending').length;
            const success = deposits.filter(d => d.status === 'completed').length;
            const total = deposits.filter(d => d.status === 'completed').reduce((s, d) => s + (d.amount || 0), 0);
            
            document.getElementById('depositCount').textContent = deposits.length;
            document.getElementById('depositPending').textContent = pending;
            document.getElementById('depositSuccess').textContent = success;
            document.getElementById('depositTotal').textContent = formatCurrency(total);
        }

        function renderDeposits() {
            if (!deposits.length) {
                document.getElementById('depositsTable').innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-400">Ch∆∞a c√≥ thanh to√°n c·ªçc</td></tr>';
                return;
            }
            document.getElementById('depositsTable').innerHTML = deposits.map(d => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 font-mono text-xs text-gray-600">${d._id}</td>
                    <td class="px-3 py-2 font-medium text-indigo-600">${roomsMap[d.room_id] || d.room_id || '--'}</td>
                    <td class="px-3 py-2">${usersMap[d.tenant_id] || usersMap[d.user_id] || d.tenant_id || '--'}</td>
                    <td class="px-3 py-2 font-semibold text-green-600">${formatCurrency(d.amount)}</td>
                    <td class="px-3 py-2">${d.method || 'VNPay'}</td>
                    <td class="px-3 py-2 font-mono text-xs">${d.transaction_id || d.provider_txn_id || '--'}</td>
                    <td class="px-3 py-2 text-gray-500">${formatDate(d.created_at)}</td>
                    <td class="px-3 py-2">${statusBadge(d.status)}</td>
                </tr>
            `).join('');
        }

        // ============ Monthly Payments ============
        function updateMonthlyStats() {
            const pending = monthlyPayments.filter(d => d.status === 'pending').length;
            const success = monthlyPayments.filter(d => d.status === 'completed').length;
            const total = monthlyPayments.filter(d => d.status === 'completed').reduce((s, d) => s + (d.amount || 0), 0);
            
            document.getElementById('monthlyCount').textContent = monthlyPayments.length;
            document.getElementById('monthlyPending').textContent = pending;
            document.getElementById('monthlySuccess').textContent = success;
            document.getElementById('monthlyTotal').textContent = formatCurrency(total);
        }

        function renderMonthly() {
            if (!monthlyPayments.length) {
                document.getElementById('monthlyTable').innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-400">Ch∆∞a c√≥ thanh to√°n ti·ªÅn ph√≤ng</td></tr>';
                return;
            }
            document.getElementById('monthlyTable').innerHTML = monthlyPayments.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 font-mono text-xs text-gray-600">${p._id}</td>
                    <td class="px-3 py-2">${p.bill_id || '--'}</td>
                    <td class="px-3 py-2 font-medium text-indigo-600">${roomsMap[p.room_id] || p.room_id || '--'}</td>
                    <td class="px-3 py-2">${usersMap[p.tenant_id] || usersMap[p.user_id] || p.tenant_id || '--'}</td>
                    <td class="px-3 py-2 font-semibold text-green-600">${formatCurrency(p.amount)}</td>
                    <td class="px-3 py-2">${p.method || 'VNPay'}</td>
                    <td class="px-3 py-2 text-gray-500">${formatDate(p.paid_at || p.created_at)}</td>
                    <td class="px-3 py-2">${statusBadge(p.status)}</td>
                </tr>
            `).join('');
        }

        // ============ Helpers ============
        function statusBadge(s) {
            const badges = {
                'pending': '<span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs">ƒêang ch·ªù</span>',
                'completed': '<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">Th√†nh c√¥ng</span>',
                'failed': '<span class="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">Th·∫•t b·∫°i</span>'
            };
            return badges[s] || s;
        }

        function formatCurrency(n) {
            return new Intl.NumberFormat('vi-VN').format(n || 0) + ' ƒë';
        }

        function formatDate(d) {
            if (!d) return '--';
            try { 
                return new Date(d).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); 
            } catch { return d; }
        }
    </script>
</body>
</html>
