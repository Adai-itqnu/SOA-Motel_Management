services:
  # MongoDB
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=motel_management
    networks:
      - motel-network
    restart: unless-stopped

  # Consul for Service Discovery
  consul:
    image: hashicorp/consul:1.16
    container_name: consul
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0
    networks:
      - motel-network
    restart: unless-stopped

  # Auth Service (Core - for login/register)
  auth-service:
    build: ./services/auth-service
    container_name: auth-service
    ports:
      - "5001:5001"
    environment:
      - SERVICE_NAME=auth-service
      - SERVICE_ID=auth-service-5001
      - SERVICE_ADDRESS=auth-service
      - MONGO_URI=mongodb://mongodb:27017/users_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5001
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
      - NOTIFICATION_SERVICE_URL=http://notification-service:5010
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped

  # Room Service (Core - for viewing rooms)
  room-service:
    build: ./services/room-service
    container_name: room-service
    ports:
      - "5002:5002"
    environment:
      - SERVICE_NAME=room-service
      - SERVICE_ID=room-service-5002
      - SERVICE_ADDRESS=room-service
      - MONGO_URI=mongodb://mongodb:27017/rooms_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5002
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped

  # User Service (CRUD Users)
  user-service:
    build: ./services/user-service
    container_name: user-service
    ports:
      - "5003:5003"
    environment:
      - SERVICE_NAME=user-service
      - SERVICE_ID=user-service-5003
      - SERVICE_ADDRESS=user-service
      - MONGO_URI=mongodb://mongodb:27017/users_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5003
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped

  # Booking Service (User booking requests)
  booking-service:
    build: ./services/booking-service
    container_name: booking-service
    ports:
      - "5005:5005"
    environment:
      - SERVICE_NAME=booking-service
      - SERVICE_ID=booking-service-5005
      - SERVICE_ADDRESS=booking-service
      - MONGO_URI=mongodb://mongodb:27017/bookings_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5005
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped

  # Contract Service (Admin contracts)
  contract-service:
    build: ./services/contract-service
    container_name: contract-service
    ports:
      - "5006:5006"
    environment:
      - SERVICE_NAME=contract-service
      - SERVICE_ID=contract-service-5006
      - SERVICE_ADDRESS=contract-service
      - MONGO_URI=mongodb://mongodb:27017/contracts_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5006
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped

  # Bill Service (Monthly bills)
  bill-service:
    build: ./services/bill-service
    container_name: bill-service
    ports:
      - "5007:5007"
    environment:
      - SERVICE_NAME=bill-service
      - SERVICE_ID=bill-service-5007
      - SERVICE_ADDRESS=bill-service
      - MONGO_URI=mongodb://mongodb:27017/bills_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5007
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped

  # Payment Service (VNPay, payments)
  payment-service:
    build: ./services/payment-service
    container_name: payment-service
    ports:
      - "5008:5008"
    environment:
      - SERVICE_NAME=payment-service
      - SERVICE_ID=payment-service-5008
      - SERVICE_ADDRESS=payment-service
      - MONGO_URI=mongodb://mongodb:27017/payments_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5008
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
      - VNPAY_TMN_CODE=${VNPAY_TMN_CODE:?VNPAY_TMN_CODE required in .env}
      - VNPAY_HASH_SECRET=${VNPAY_HASH_SECRET:?VNPAY_HASH_SECRET required in .env}
      - VNPAY_URL=${VNPAY_URL:-https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
      - VNPAY_RETURN_URL=${VNPAY_RETURN_URL:-http://localhost/api/payments/vnpay/return}
      - VNPAY_CONFIRM_MODE=${VNPAY_CONFIRM_MODE:-return}
      - VNPAY_IPN_URL=${VNPAY_IPN_URL:-}
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped


  # Report Service
  report-service:
    build: ./services/report-service
    container_name: report-service
    ports:
      - "5009:5009"
    environment:
      - SERVICE_NAME=report-service
      - SERVICE_ID=report-service-5009
      - SERVICE_ADDRESS=report-service
      - MONGO_URI=mongodb://mongodb:27017/bills_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5009
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
    depends_on:
      - mongodb
      - consul
    networks:
      - motel-network
    restart: unless-stopped

  # Notification Service
  notification-service:
    build: ./services/notification-service
    container_name: notification-service
    ports:
      - "5010:5010"
    environment:
      - SERVICE_NAME=notification-service
      - SERVICE_ID=notification-service-5010
      - SERVICE_ADDRESS=notification-service
      - MONGO_URI=mongodb://mongodb:27017/notifications_db
      - JWT_SECRET=your-super-secret-key-change-this
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
      - SERVICE_PORT=5010
      - INTERNAL_API_KEY=${INTERNAL_API_KEY:-internal-secret-key}
      - USER_SERVICE_URL=http://user-service:5003
      - BILL_SERVICE_URL=http://bill-service:5007
    depends_on:
      - mongodb
      - consul
      - user-service
    networks:
      - motel-network
    restart: unless-stopped

  # Frontend (internal only - access via nginx port 80)
  frontend:
    build: ./frontend
    container_name: frontend
    expose:
      - "3000"
    networks:
      - motel-network
    restart: unless-stopped

  # Nginx API Gateway
  nginx:
    build: ./nginx
    container_name: nginx-gateway
    ports:
      - "80:80"
    environment:
      - CONSUL_HOST=consul
      - CONSUL_PORT=8500
    depends_on:
      - consul
      - frontend
      - auth-service
      - room-service
      - user-service
      - booking-service
      - contract-service
      - bill-service
      - payment-service
      - notification-service
      - report-service
    networks:
      - motel-network
    restart: unless-stopped

networks:
  motel-network:
    driver: bridge

volumes:
  mongodb_data:
